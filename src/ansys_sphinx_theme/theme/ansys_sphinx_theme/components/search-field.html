<form class="bd-search d-flex align-items-center"
      action="{{ pathto('search') }}"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="{{ theme_search_bar_text }}"
         aria-label="{{ theme_search_bar_text }}"
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>

</form>

  <!-- Add this div to show the search results -->
  <div id="results" class="results"></div>

  <style>
    .results {
      margin-top: 3rem;
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        align-content: flex-start;
        justify-content: center;
        position: absolute;
        background-color: white;
        width: 800px;
        padding: 0 10px;
    }

    .result-item {
      margin-bottom: 1rem;
    }

    .result-title {
      font-size: 1.25rem;
      font-weight: bold;
    }

    .result-text {
      font-size: 1rem;
    }

    .highlight {
      background-color: yellow;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>

  <!-- Script tag for search functionality -->
  <script>
    require.config({
      paths: {
        fuse: "https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min"
      }
    });

    require(['fuse'], function(Fuse) {
      // Function to initialize Fuse.js and set up search functionality
      function initializeFuse(data) {
        const fuseOptions = {
          keys: ['title', 'text'],
          includeScore: true
        };

        const fuse = new Fuse(data, fuseOptions);

        function performSearch(query) {
          const results = fuse.search(query);
          const resultsContainer = document.getElementById('results');
          resultsContainer.innerHTML = '';

          if (results.length === 0) {
          const noResultsMessage = document.createElement('div');
          noResultsMessage.className = 'no-results';
          noResultsMessage.textContent = 'No matched documents';
          resultsContainer.appendChild(noResultsMessage);
          return; // Exit the function early
          }

          results.forEach(result => {
            const item = document.createElement('div');
            item.className = 'result-item';
            const { title, text } = result.item;
            const snippet = getSnippet(text, query);
            item.innerHTML =
              `<div class="result-title">${highlightTerms(title, query)}</div>` +
              `<div class="result-text">${snippet}</div>`;
            resultsContainer.appendChild(item);
          });
        }

        function highlightTerms(text, query) {
          if (!query.trim()) return text;
          const terms = query.split(/\s+/);
          const regex = new RegExp(`(${terms.map(term => term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|')})`, 'gi');
          return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function getSnippet(text, query) {
          if (!query.trim()) return text;
          const terms = query.split(/\s+/);
          const regex = new RegExp(`(${terms.map(term => term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|')})`, 'gi');
          const match = regex.exec(text);
          if (!match) return text;
          const startIndex = Math.max(0, match.index - 50);
          const endIndex = Math.min(text.length, match.index + match[0].length + 50);
          const snippet = text.slice(startIndex, endIndex);
          return highlightTerms(snippet, query);
        }

        // Use querySelector instead of getElementById
        document.querySelector(".bd-search input")
                .addEventListener("input", function () {
            const query = this.value.trim();
            performSearch(query);
        });
      }

      // Fetch the data from search.json and initialize Fuse.js
      fetch('{{ pathto("search.json", 1) }}')
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          initializeFuse(data);
        })
        .catch(error => {
          console.error('There was a problem with the fetch operation:', error);
        });
    });
  </script>

